[gcode_macro _global_var]
variable_pause_park:{'x': 1, 'y': 1, 'z': 10, 'e': 1}
variable_cancel_park:{'x': 1, 'y': 350, 'z': 10, 'e': 1}
variable_z_maximum_lifting_distance: 345
variable_pause_resume_travel_speed: 150
variable_bed_mesh_calibrate_target_temp: 60
variable_load_filament_extruder_temp: 200
variable_min_extrude_temp: 185
variable_preheat_bed: 50
gcode:

[gcode_macro START_PRINT]
gcode:
    status_strobo
    G4 P1500
    M400
    status_busy
    M117 Prepare
    HIGH_CURRENT
    SET_VELOCITY_LIMIT VELOCITY=650
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5
    SET_VELOCITY_LIMIT ACCEL=11000
    SET_VELOCITY_LIMIT MINIMUM_CRUISE_RATIO=0.5
    SET_LED LED=main_led WHITE=0.75 SYNC=0 TRANSMIT=1
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(210)|float %}
    {% set BED_TEMP = params.BED|default(50)|float %}
    {%set material = params.MATERIAL %}
    {%set vendor = params.VENDOR %}
    _SET_TIMELAPSE_SETUP ENABLE=true
    M400
    CLEAR_PAUSE
    BED_MESH_CLEAR
    SET_GCODE_OFFSET Z=0.0000
    M400
    SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=toolhead TARGET=30
    M140 S{BED_TEMP}
    M117 Homing
    {% if printer.toolhead.homed_axes|lower != "xyz" %}
        G28
    {% endif %}
    G4 P250
    {% if printer['filament_switch_sensor filament_sensor'].enable == True and
          printer['filament_switch_sensor filament_sensor'].filament_detected != True
    %}
      M117 No filament!!!  
     {action_respond_info("Pause Print!")}
        PAUSE
     {% endif %}
    M117 Heating bed
    G1 X1 Y360 Z50 F15000
    M106 S64
    status_bedtemp
    M190 S{BED_TEMP}
    status_busy
    {% if material == "PLA" %}
        {% for i in range(700) %} #700
           {% set remaining = 700 - i %}
            M117 Remaining heat soak time: {"%02d:%02d" % (remaining // 60, remaining % 60)}
            G4 P1000
      {% endfor %}
    {%else%}
        {% for i in range(900) %} #900
           {% set remaining = 900 - i %}
            M117 Remaining heat soak time: {"%02d:%02d" % (remaining // 60, remaining % 60)}
            G4 P1000
      {% endfor %}
    {% endif %}
    M117 Quad Gantry Level
    status_leveling
    QUAD_GANTRY_LEVEL_BASE
    G1 X1 Y360 Z50 F15000
    M400
    M117 Preheat nozzle
    status_nozzletemp
    M109 S150
    M117 Nozzle cleaning
    status_cleaning
    CLEAN_NOZZLE
    M117 Tap Z
    status_homing
    G1 X225 Y225 Z15    
    G4 P1000
    TAP
    G1 Z2
    SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=toolhead TARGET=45
    M106 S0
    M117 Bed mesh calibrate
    status_meshing
    BED_MESH_CALIBRATE
    G1 X5 Y5 Z15 F12000
    M117 Final heating
    status_bedtemp
    M190 S{BED_TEMP}
    G4 P1000
    status_nozzletemp
    M109 S{EXTRUDER_TEMP}
    G4 P3000
    M400
    status_knight_raider
    M117 Purge
    G90
    G92 E0
    G1 X80 Y1 Z1 F12000
    G1 X270 Y1 Z1 E53 F1500
    G92 E0
    G1 X270 Y2 Z1 F12000
    G1 X80 Y2 Z1 E53 F2400
    G92 E0
    G1 E-3 F2400
    G92 E0
    G1 Z15 F2400
    G1 X20 Y20 F12000
    M400
    SET_LED LED=main_led WHITE=0.15 SYNC=0 TRANSMIT=1
    SKEW_PROFILE LOAD=calilantern_skew_profile
    M117 Printing with {vendor} {material}
    M400
    BED_MESH_PROFILE LOAD=default
    M400
    status_printing
        
    
[gcode_macro END_PRINT]
gcode:
    status_busy
    {% set z_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance|int %}
    {% set e_mintemp  = printer.configfile.settings['extruder'].min_extrude_temp %}
    SET_SKEW CLEAR=1
    SET_GCODE_OFFSET Z=0.0000
    bed_mesh_clear
    M400
    M117 Finish Print
    G91
    {% if printer['filament_switch_sensor filament_sensor'].enable == True and
          printer['filament_switch_sensor filament_sensor'].filament_detected == True %}
            G1 E-10 Z0.2 F2700
            G4 P5000
            G1 E-3 Z0.1 F2400
            G4 P5000
            G1 E-3 F2400
    {% endif %}

    {% if (printer.gcode_move.position.z + 20) < z_max %}
        G1 Z+20 F3000
    {% else %}
        G1 Z+{(z_max - printer.gcode_move.position.z)} F3000
    {% endif %}
    TURN_OFF_HEATERS
    M106 S250
    M117 Cool down
    status_busy
    G4 P30000
    M106 S200
    M117 2nd cool down
    G4 P45000
    M400
    G90
    G1 X0 Y360 F9000
    M107
    M84
    M220 S100
    M221 S100
    M400
    M117 Finish Print!
    SET_VELOCITY_LIMIT ACCEL=30000
    SET_VELOCITY_LIMIT VELOCITY=600
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5
    SET_VELOCITY_LIMIT MINIMUM_CRUISE_RATIO=0.33
    SET_LED LED=main_led WHITE=0.0 SYNC=0 TRANSMIT=1
    LOW_CURRENT
    CLEAR_PAUSE
    SET_GCODE_OFFSET Z=0.0000
    PROBE_EDDY_NG_SET_TAP_OFFSET VALUE=0
    M400
    status_ready           


[safe_z_home]
home_xy_position: 200, 200 #194.5, 172
z_hop: 5
z_hop_speed: 10
speed: 200
move_to_previous: False


[gcode_macro CLEAN_NOZZLE] 
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
       G28
    {% endif %}
    G90 
    G1 X194.5 Z10 F9000
    G1 Y360 F9000
    G90
    M106 S255
    M117 Clean nozzle
    G1 X315 Y360 F9000
    G1 Z1.5 F300
    G1 X352 F4500
    G1 Y360 X324
    G1 Y360 X345
    G1 Y360 X324
    G1 Y360 X345
    G1 Y360 X324
    G1 Y360 X345
    G1 Y360 X324
    G1 Y360 X345
    G1 Y360 X324
    G1 Y360 X325
    G1 Y356 X324 Z5
    G1 Z1.5
    G1 Y360 X324
    G1 Y357 X326
    G1 Y360 X326
    G1 Y357 X328
    G1 Y360 X330
    G1 Y357 X332
    G1 Y360 X334
    G1 Y357 X336
    G1 Y360 X338
    G1 Y357 X340
    G1 Y360 X324
    G1 Y357 X326
    G1 Y360 X326
    G1 Y357 X328
    G1 Y360 X330
    G1 Y357 X332
    G1 Y360 X334
    G1 Y357 X336
    G1 Y360 X338
    G1 Y357 X340
    G1 Y360 X324
    G1 Y357 X326
    G1 Y360 X326
    G1 Y357 X328
    G1 Y360 X330
    G1 Y357 X332
    G1 Y360 X334
    G1 Y357 X336
    G1 Y360 X338
    M400
    G1 Y360 X338 Z10 F9000
    M117 Clean Finish
    M107 
    G90
    G1 X1 Y360 Z10 F9000

[gcode_macro G28]
rename_existing: G28.1
gcode:
  {% if not 'Z' in params and not 'Y' in params and 'X' in params %}
    G28.1 X
    M400
    _CLIENT_LINEAR_MOVE X=-50 F=5000
  {% elif not 'Z' in params and not 'X' in params and 'Y' in params %}
    G28.1 Y
  {% elif not 'Z' in params and 'X' in params and 'Y' in params %}
    G28.1 X
    M400
    _CLIENT_LINEAR_MOVE X=-50 F=5000
    M400
    G28.1 Y
  {% elif not 'X' in params and not 'Y' in params and 'Z' in params %}
    G28.1 Z
    G90
    G0 Z1 F1000
    G4 P1500
    M400
    M117 Z-Offset Calibration
    PROBE_EDDY_NG_PROBE_STATIC HOME_Z=1
  {% else %}
    G90
    G28.1 X
    M400
    _CLIENT_LINEAR_MOVE X=-50 F=5000
    M400
    G28.1 Y
    G28.1 Z
    G90
    G0 Z1 F1000
    G4 P1500
    M400
    M117 Z-Offset Calibration
    PROBE_EDDY_NG_PROBE_STATIC HOME_Z=1
    G4 P2000
  {% endif %}
  G4 P1000
  M400
  M117
  G1 Z15 F1600


[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing:QUAD_GANTRY_LEVEL_BASE
gcode:
    {% set mesh_name = "default" %}
    {% set mesh_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int %}
    {% set current_target_temp  = printer.heater_bed.target|int %}

    {% if printer.heater_bed.temperature < mesh_calibrate_temp %}
        M140 S{mesh_calibrate_temp}
        {action_respond_info("Bed heating...")}
        M190 S{mesh_calibrate_temp}
    {% endif %}

    {% if printer.toolhead.homed_axes|lower != "xyz" %}
        G28
    {% endif %}

    QUAD_GANTRY_LEVEL_BASE

    {% if current_target_temp == 0 %}
        M140 S0
    {% endif %}
    G0 X175 Y175 Z30 F3600

[gcode_macro BED_MESH_CALIBRATE]
rename_existing: BTT_BED_MESH_CALIBRATE
gcode:
  BTT_BED_MESH_CALIBRATE METHOD=rapid_scan ADAPTIVE=0

[gcode_macro G34]
gcode:
    BED_MESH_CLEAR 
    {% if printer.toolhead.homed_axes|lower != "xyz" %}
      G28
    {% else %}
      G28 Z
    {% endif %}
    QUAD_GANTRY_LEVEL 
    G28 Z 
    G0 X175 Y175 Z30 F3600


[gcode_macro RUNOUT]
description: Remove Filament from extruder
gcode:
    G1 E-10 F1500
    G4 P1000
    G1 E-10 F1500
    G4 P1000
    G1 E-10 F1500
    G4 P1000
    G1 E-20 F800
    G4 P3000
    G1 E-20 F600
    G4 P3000


[gcode_macro LOAD_FILAMENT]
gcode:
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
        ACTIVATE_EXTRUDER EXTRUDER=extruder1
        M117 Extruding...
        G91 
        G1 E45 F300
        G1 E-5 F300
        G1 E30 F250
        G1 E-5 F300
        G1 E30 F200
        G1 E-5 F300
        G1 E30 F150
        G1 E-5 F300
        G1 E30 F150
        G1 E-0.8 F300
        G90
        M400
        M117 Extrude Finish
        M400
        {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
        {action_respond_info("Don't load filament during printing!!!")}
    {% endif %}

    
[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
        ACTIVATE_EXTRUDER EXTRUDER=extruder1
        M117 Retracting...
        G91
        G1 E+25 F300
        G1 E-10 F1500
        G1 E-20 F600
        M400
        G4 P3000
        G1 E-50 F300 
        G90
        M400
        M117 Retract Finish
        M400
        {% if current_target_temp == 0 or printer.print_stats.state != "paused"%}
            M104 S0
        {% endif %}
    {% else %}
        {action_respond_info("Don't unload filament during printing!!!")}
    {% endif %}

[gcode_macro M109]
rename_existing: M99109
gcode:    
    {% set s = params.S|float %}    
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-1} MAXIMUM={s+1}   
    {% endif %}
    
[gcode_macro M190]
rename_existing: M99190
gcode:    
    {% set s = params.S|float %}
    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}   
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-1} MAXIMUM={s+1}  
    {% endif %}
    
[gcode_macro M600]
gcode:
    PAUSE STATE=filament_change

[gcode_macro LED_OFF]
gcode:
    SET_LED LED=main_led WHITE=0.0 SYNC=0 TRANSMIT=1
    
[gcode_macro LED_50]
gcode:
    SET_LED LED=main_led WHITE=0.5 SYNC=0 TRANSMIT=1

[gcode_macro LED_ON]
gcode:
    SET_LED LED=main_led WHITE=1.0 SYNC=0 TRANSMIT=1

[gcode_macro Z_to_max]
gcode:
  G1 Z330 F1500
  G1 Z340 F1100
  G1 Z347 F400

[gcode_macro PID_TUNE_BED]
gcode:
  M117 PID tuning bed
  PID_CALIBRATE HEATER=heater_bed TARGET=85
  M400
  M117 Cool down and save
  G4 P30000
  SAVE_CONFIG

[gcode_macro PID_TUNE_EXTRUDER]
gcode:
  M117 PID tuning extruder with delta at 5.0
  PID_CALIBRATE HEATER=extruder TARGET=280 WRITE_FILE=1 TUNE_PID_DELTA=5.0
  M400
  M117 Cool down
  G4 P30000
  M117 PID tuning extruder with delta at 2.5
  PID_CALIBRATE HEATER=extruder TARGET=280 WRITE_FILE=1 TUNE_PID_DELTA=2.5

[gcode_macro Shaper]
gcode:
	AXES_SHAPER_CALIBRATION

[gcode_macro Spoolman_SET_ACTIVE_SPOOL]
gcode:
  {% if params.ID %}
    {% set id = params.ID|int %}
    {action_call_remote_method(
       "spoolman_set_active_spool",
       spool_id=id
    )}
  {% else %}
    {action_respond_info("Parameter 'ID' is required")}
  {% endif %}

[gcode_macro Spoolman_CLEAR_ACTIVE_SPOOL]
gcode:
  {action_call_remote_method(
    "spoolman_set_active_spool",
    spool_id=None
  )}

[gcode_macro Adjust_Bed_Screws]
gcode:
  G28 Z
  G0 Z20
  SCREWS_TILT_CALCULATE
  G0 Z250

[gcode_macro LOW_CURRENT]
gcode:
  SET_TMC_CURRENT STEPPER=stepper_z CURRENT=0.2 HOLDCURRENT=0.2
  SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=0.2 HOLDCURRENT=0.2
  SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT=0.2 HOLDCURRENT=0.2
  SET_TMC_CURRENT STEPPER=stepper_z3 CURRENT=0.2 HOLDCURRENT=0.2
  SET_TMC_CURRENT STEPPER=stepper_x CURRENT=0.6 HOLDCURRENT=0.6
  SET_TMC_CURRENT STEPPER=stepper_y CURRENT=0.6 HOLDCURRENT=0.6

[gcode_macro HIGH_CURRENT]
gcode:
  SET_TMC_CURRENT STEPPER=stepper_z CURRENT=0.58 HOLDCURRENT=0.58
  SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=0.58 HOLDCURRENT=0.58
  SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT=0.58 HOLDCURRENT=0.58
  SET_TMC_CURRENT STEPPER=stepper_z3 CURRENT=0.58 HOLDCURRENT=0.58
  SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.1 HOLDCURRENT=1.1
  SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.1 HOLDCURRENT=1.1

[delayed_gcode _LOWCURRENT_WAIT]
initial_duration: 3.0
gcode:
    LOW_CURRENT

[gcode_macro TAP]
gcode:
    M400
    LOW_CURRENT
    G4 P500
    PROBE_EDDY_NG_SET_TAP_OFFSET VALUE=0
    PROBE_EDDY_NG_TAP START_Z=10 SAMPLES_STDDEV=0.03 target_Z=-0.4 THRESHOLD=200 MAX_SAMPLES=10 SPEED=5 LIFT_SPEED=10.0
    HIGH_CURRENT
    G4 P500
    M400